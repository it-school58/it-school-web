<h2>Сохранение изображения на сервере (jpg, png)</h2>

<!------------------------------------------------------------->
<h4>index.html</h4>
<!------------------------------------------------------------->
<v-code lang="html" title="">
&lt;label class="input-image" id="img1"&gt;
	&lt;input type="file" accept="image/*" onchange="imageLoad('img1', this);" class="input-file"&gt;
&lt;/label&gt;

&lt;button onclick="imageSave('img1');"&gt;Сохранить изображение&lt;/button&gt;
</v-code>

<!------------------------------------------------------------->
<h4>css/main.css</h4>
<!------------------------------------------------------------->
<v-code lang="css" title="">
.input-image {
    border: 2px dashed rgba(137,31,112,0.4);
    background-color: #fbfbfb;
    width: 200px;
    height: 200px;
    display: block;
    cursor: pointer;
    background-repeat: no-repeat;
    background-position: center center;   
    background-size: cover;
    margin: 10px;
}
.input-file {
    display: none;
}
</v-code>

<!------------------------------------------------------------->
<h4>php/saveImage.php</h4>
<!------------------------------------------------------------->
<v-code lang="php" title="">
&lt;?php
	$picture   = $_POST[picture];   // изображение в base64
	$file      = $_POST[file];      // путь без расширения
	$extension = $_POST[extension]; // расширение
	$path      = $file.$extension;

	// конвертирование base64 в изображение
	$picture = base64_decode($picture);
	$picture = imagecreatefromstring($picture);

	// проверка расширения
	if ($extension == '.png') {
		imagealphablending($picture, false); // выключение альфа сопряжения
		imagesavealpha($picture, true);      // установка альфа флага
		header('Content-Type: image/png');   // header
		imagepng($picture, $path);           // сохранение изображения
	} else {
		imagejpeg($picture, $path, 100);
	}

	// освобождение памяти
	imagedestroy($picture);
?&gt;
</v-code>

<!------------------------------------------------------------->
<h4>js/main.js</h4>
<!------------------------------------------------------------->
<v-code lang="js" title="">
// Загрузка изображения из input file в блок
// 1 - input - изображение из input
// 2 - id    - блок для устанавки изображения на background-image
function imageLoad(id, input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function() {
            $('#'+id).css('background-image', 'url('+reader.result+')');
        }
        reader.readAsDataURL(input.files[0]);
    }
}
</v-code>

<v-code lang="js" title="">
// Сохранение изображения на сервер
// 1 - id - id изображения
function imageSave(id) {
    var picture = $('#'+id).css('background-image');
    if (isNewPicture(picture)) {
        var file = '../uploads/'+id;
        var extension = imageExtension(picture);
        picture = imageParse(picture); 
        $.post("php/saveImage.php", {picture:picture, file:file, extension:extension});
    } 
}
</v-code>

<v-code lang="js" title="">
// Проверка на новое изображение
// 1 - picture - изображение в base64
function isNewPicture(picture) {
    if ((picture.indexOf('uploads')==-1) && (picture!='none')) {
        return true;
    } else {
        return false;
    }
}
</v-code>

<v-code lang="js" title="">
// Определение расширения
// 1 - picture - изображение в base64
function imageExtension(picture) {
    if (picture.indexOf('data:image/png') == -1) {
        return '.jpg';
    } else {
        return '.png';
    }
}
</v-code>

<v-code lang="js" title="">
// Разбор изображения в base64 и вырезка только части, описывающей само изображение
// изображение в формате base64:
// - "url("data:image/png;base64,"
// - само изображение "..."
// - ")
// формат может быть png, jpeg и т.д., поэтому мы ищем совпадение по фразе "base64", 
// чтобы оставить только данные самого изображения
// ищем позицию элемента
// прибавляем 7 - это символы base64,
// вычитаем 2 - это символы ")
function imageParse(picture) {
    var position = picture.search(/base64/) + 7; 
    var result = picture.slice(position, picture.length-2); 
    return result;
}
</v-code>